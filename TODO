$Id$


devicetable.cc: convert to 2-character codes.  need to dyanmically
                create/delete them. yuck.

--------
printing
--------
- remove print statements from all 'run' threads.  only Setup() should
    output anything.  however, that's not really safe, since they
    could interleave with concurrent clients starting different 
    devices.  mutex?

    - yep. make some kind of SAFE_PRINTF that will lock, print, and
        unlock a single global mutex.
          - but, make sure that potentially blocking on a mutex
              when you expected to return quickly from a print
              won't fuck up close timing.

- add back in SOME of the laser output to Setup().



TOMORROW:
---------
- protocol
    - add timestamp to all data
    - add extra byte for device names?
    - add ability to send other types of commands (relative instead
        of absolute)
           - config command to change interpretation of future commands?
           - extra byte to allow different kinds of commands?
           - extra device that takes different commands?
    - add ability to only send 'new' commands.
         - config command to set state.
    - add ability to check current config, when possible; analogous to
        fcntl(F_GETFL) and fcntl(F_SETFL).

- gut C++ client.
  - make other Write() method for various devices
  - make functional interface to commands/data?
  + make smarter in terms of current configuration status.
      should be able to:
        + Read() with no args
        + Write() with no args but only write the right devices
        - make Request() much smarter (e.g., handle device closures)
  + make usable examples of c++ client.
  + edit docs for c++ client

- change mailing list to 'players@fnord'

- enforce read/write semantics (e.g. return error on "lw")

+ pan direction in ptz control?
    - only broken in simulator

- make it work under inetd.
   - NO.  just bring it up on system boot. maybe add script
       in /etc/rc.d/init.d and proper links.

IMMEDIATE:
----------
- acts on old robots (tanis&milka) takes a LONG time to start up the
    first time (presumably before it's swapped in); Golem hangs.  wait
    longer?

- add conditionals for connecting to 2-AT's.  should be easypeasyjapaneasy.

- what to do when a client disconnects? should 'zero' all relevant
    command buffers for safety.  if other clients want to overwrite, they
    can.

- gripper: new control loop that monitors current condition, and commands
    according to client's desired setting
     - maybe should have control loop in client_reader....no, that
         would suck.  need to keep control within RunPsosThread,
         just multiplex between that and motor control.

LATER:
------
+ bee ptz control broken
    - fixed it. IRQ mismatch.  need to check comet and atom, probably.

- compass: check newer P2OS versions for compass 
      compatibility.
   - version 1.B (on fly) seems to work fine.  just
      need to calibrate compass.
   - try version 1.D, if it works, upgrade everyone and
      calibrate all compii
   - MORE COMPLEX....not all compass are the same.  maybe
      need old P2OS with old compass.  fuck activmedia. fuck
      them with a great big dick.
  
- check on gripper commanding.  whine is bad.

- remove non-portable pthread behavior.  should be confined to:
      + pthread_kill_other_threads_np(). GONE
      - unlocking mutex owned by other thread.  probably just
          CClientData::datareqeusted for request/reply mode.  need
          different idea.

- P2OS stuff (really needs a whole rewrite):
    - do error-checking on calls to:
        - CPacket::Build()
        - CPacket::Receive()
        - CPacket::Send()
        - others?
    - add capability to reconnect
        - but how?  symptom will be no SIP when one is expected.
          maybe set a timer to go off after 15ms and wake up
          the read, then do a Reconnect()?
             - tried that; still very flaky...
    + add position Reset.  DONE
    + remove calls to exit() from packet.cc
    + fix P2OSDevice::Setup() to not block waiting for SYNC0, thereby
        able to detect lack of P2OS.
    + failed startup occasionally, maybe especially on older 
      versions.  
        + hopefully fixed, because of tcflush().
        + much more robust startup now
      

LATENT:
-------
+ milka dead?
    - replaced fuse.
    - why did the fuse blow? blocked cooling fan?

- on tanis & v.0.6.5, one time only got 720 bytes from a laser
     data packet.  why?
       - now running client ON tanis.  maybe that fixes it?  that
           would be bad.
       - happened more than once.  data's not queuing up, though...

DONE:
------
+ add 'distro' target to Makefile.  should:
    + latex && cp golem.ps to ./doc
    + cd .. && tar hcvzf ..... 

+ figure out Boyoon's Golem-0.7/Arena-0.6.6 problem.
    - done.  was 'offsets.h' inconsistency.

+ document:
    + CRobot::ResetPosition()
    + 'z' device.
    + no commands to 'v' device.
    + 'xR' command.
    + talk about more robust P2OS control, mention direct wheel velocity...

+ change 'xr' to 'xr<val>' to switch between req/rep and cont

+ add ResetPosition() and ChangeVelocityMode() methods to CRobot class.

+ check out hanging on lack of PTZ device.  maybe do a test
   non-blocking read at first?
     - yep, and it worked

+ figure out direct wheel velocity control.  cuts down motor
    command packet count to one per cycle.  just try to send
    it every time; sometimes you block on the mutex because
    someone else is writing a config command or whatever; no big 
    deal.

+ RunPsosThread will now just call SendReceive() with the
    joint direct wheel velocity packet every run through.

+ eXpert commands now are implemented as calls to SendReceive()
    from the client_reader() thread.  not so bad, might block for
    a bit.

+ add private 'serial_mutex' to CP2OSDevice.  also public method
   'SendReceive(CPacket pkt)', which will lock on the mutex,
   send 'pkt', block on receive for a SIP, then return.

+ MUTEX ACCESS TO CLIENT SOCKET!  why didn't we do that before.  that
    HAS to be the reason for garbled responses to eXpert commands.
    what the hell was i thinking.
      - CClientData->socketwrite

+ PTZ device hangs after many commands. why?
    + also maybe it hangs Golem.  how?
    + glitches in the messaging.  seems to be fixed now.
        only have a problem after very stressful stop/restart

+ debug the loss of control problem.  see if it's the server
   or the client (hopefully the client).
     - maybe it was the server overloading P2OS.  put in checks
         so it only sends 'new' commands.  should cut down on serial
         line usage.
     - heavily cut down packet flow by removing unneeded GETAUX
         commands.  reinvestigate if we need PTZ feedback. seems
         solved now.

+ segfault when Control-C server sometimes.  leaves P2OS open and
    pinging.
      - problem was that client_writer threads were calling <device>.GetData()
          after <device> had been deleted, but before the main loop exited.
          solution was to keep track of CClientData pointers, and delete
          them one by one before deleting the devices.  nice shutdown
          behavior now.

+ after Control-C, says "Quitting", but then hangs sometimes.  especially 
    after laser startup error.  mutex locked somewhere, i guess.
      - can't reproduce on ant w/ no laser (v.0.5.1 8/18 BPG)
      - can't reproduce on tanis w/ no laser (v.0.6.5 8/18 BPG)

+ make read loop smarter in client_reader (main.cc).  should read 
    whole messages. 
      - added two-byte header and two-byte size specifier
          to device request messages.  makes read loop
          much better.  not to self: always include size
          in variable length messages...

+ when ACTS fails to start, server gives back error but does
    not shut down P2OS connection.
      - just had to Unsubscribe the positiondevice before returning
        on all Setup() failures.

+ robot.Request("pc",2) fails because the server never sends back a reply.
   should it?
     - yes.  adding 'c' permission descriptor. need to:
        - make sure shutdown is detected. DONE
        - make sure RemoveBlanks() works. DONE

+ camera: set it back to "normal" state on shutdown of vision device.
   DONE.

+ Java client:
  + ask esben how to layout .java files.
      + what about a Makefile?
      + how can source in examples/java load class from client_libs/java?

+ document MAXNUMTHREADS (8) and implications

